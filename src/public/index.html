<!DOCTYPE html>
<html >
  <head>
    <meta charset="UTF-8">
    <title>JoyTracker</title>




        <link rel="stylesheet" href="/style.css">




  </head>

  <body>

    <div class="sidebar"> <img class="photo" src="https://upload.wikimedia.org/wikipedia/commons/e/e8/Emoji_u1f366.svg" </img><a> JoyTracker</a> <img class="photo" src="https://upload.wikimedia.org/wikipedia/commons/e/e8/Emoji_u1f366.svg"> </img> <br></br><input type="text" id="user"
    name="username" placeholder="Username" style="font-size: 20px;"></input>
<br></br>
  <input type="text" id="desc" name="description" placeholder="Description" style="font-size: 20px; margin-top: 5px;"></input>
  <div class="button" id="lel" onclick="sendData()"> submit location</div>
</div>
<div id="map"></div>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
<script>
var socket = io.connect('http://localhost:3000');
socket.on('mark', function(data) {
  console.log("mark on client");
  getGeo(data.username, data.description, data.coor, data.time);
});
var map;
function initMap() {
  var wyo =  {lat: 40.329, lng: -75.965};
  map = new  google.maps.Map(document.getElementById('map'), {
     center: wyo,
          zoom: 15
  });

  var info1 = new google.maps.InfoWindow({content: "Last seen here by <b>DinkleBerg</b>, heading North<br> <i>just now</i></br>"});
  var marker1 = new google.maps.Marker({
    position: {lat: 40.330, lng: -75.955},
    map: map,
    title: "Ice Cream Truck Spotted"
  });
  marker1.addListener('click', function () {
    info1.open(map, marker1);
  });
}

function sendData() {
  var stamp = parseInt(moment().format('hmmss'));
  var user = document.getElementById("user").value;
  var desc = document.getElementById("desc").value;

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      socket.emit('spot', {username: user, description: desc, coor: pos, time: stamp});
    }, function() {
      handleLocationError(true, infoWindow, map.getCenter());
    });
  } else {
    handleLocationError(false, infoWindow, map.getCenter());
  }
}
function getGeo(user, desc, pos, stamp) {
  var infoWindow = new google.maps.InfoWindow();
  var marker = new google.maps.Marker({
        position: pos,
        map: map,
        title: "Ice Cream Truck Spotted"
  });
      map.setCenter(pos);
      marker.addListener('click', function () {
        infoWindow.open(map, marker);
      });
      var cont = setInterval(function() {
        var num = parseInt(moment().format('hmmss')) - stamp;
        if (num < 60) {
          infoWindow.setContent("Last seen here by <b>" + user + "</b>, " + desc +"<br> <i> about " + num + " second(s) ago </i> </br>");
        }
        else if (num > 60) {
          infoWindow.setContent("Last seen here by <b>" + user + "</b>, " + desc +"<br> <i> about 1 minute ago </i> </br>");
        }
      }, 1000);
      var interv = setInterval(function() {
        console.log(parseInt(moment().format('hmmss')) - stamp);
        if (parseInt(moment().format('hmmss')) - stamp > 120) {
          socket.on('delete', function() {
            console.log("deleting marker");
            marker.setMap(null);
            clearInterval(cont);
            clearInterval(interv);
          })
        }
      }, 3000);
}

function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=LOL&callback=initMap" async defer></script>



  </body>
</html>
